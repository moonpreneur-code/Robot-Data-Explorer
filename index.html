<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Data Analyzer - Hybrid Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a repeating pattern for the 'floor' */
        #simulation-area {
            position: relative;
            width: 100%;
            height: 100%;
            /* Tiled grid/track background */
            background-color: #e0f2f1;
            background-image: 
                linear-gradient(to right, #b2dfdb 1px, transparent 1px),
                linear-gradient(to bottom, #b2dfdb 1px, transparent 1px);
            background-size: 30px 30px; /* Size of the grid cells */
            background-repeat: repeat;
            /* Border and aesthetics */
            border: 4px dashed #00897b;
            overflow: hidden;
            border-radius: 1rem;
            
            /* Start the background position */
            background-position: 0 0; 
            transition: background-position 0.1s linear; /* Smooth transition */
        }

        /* Realistic Car Design */
        #robot-car {
            position: absolute;
            width: 80px;
            height: 120px;
            /* Start from center relative to the simulation area */
            top: calc(50% - 60px); 
            left: calc(50% - 40px);
            background: linear-gradient(180deg, #2c3e50 0%, #1b2838 100%);
            border-radius: 16px;
            border: 2px solid #111;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.4);
            transform-origin: center;
            /* Transform applies translation (movement) and rotation */
            transition: transform 0.1s linear; 
            z-index: 10;
        }

        /* Windshield, Wheels, Headlights, and Animations (Unchanged) */
        #robot-car::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            height: 25px;
            background: linear-gradient(180deg, #76c7c0 0%, #2c3e50 100%);
            border-radius: 6px;
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.3);
        }

        #robot-car .wheel {
            position: absolute;
            width: 14px;
            height: 28px;
            background-color: #111;
            border-radius: 6px;
            box-shadow: inset 0 0 4px #333;
            background-image: 
                linear-gradient(0deg, #333 0px, #333 3px, transparent 3px, transparent 7px),
                linear-gradient(45deg, #444 0px, #444 2px, transparent 2px, transparent 4px);
            background-size: 100% 14px, 100% 8px;
            background-repeat: repeat;
        }

        #robot-car .wheel.front-left  { top: 10px; left: -10px; }
        #robot-car .wheel.front-right { top: 10px; right: -10px; }
        #robot-car .wheel.back-left   { bottom: 10px; left: -10px; }
        #robot-car .wheel.back-right  { bottom: 10px; right: -10px; }

        #robot-car .headlight {
            position: absolute;
            top: 2px;
            width: 10px;
            height: 6px;
            background: radial-gradient(circle, #fff8b3 20%, #fdf4a6 50%, transparent 100%);
            border-radius: 3px;
            animation: headlight-glow 2s ease-in-out infinite;
        }
        #robot-car .headlight.left { left: 14px; }
        #robot-car .headlight.right { right: 14px; }

        @keyframes headlight-glow {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        @keyframes wheel-spin-fwd {
            from { background-position: 0 0, 0 0; }
            to { background-position: 0 14px, 0 8px; }
        }

        @keyframes wheel-spin-bwd {
            from { background-position: 0 0, 0 0; }
            to { background-position: 0 -14px, 0 -8px; }
        }

        #robot-car.moving-forward .wheel {
            animation: wheel-spin-fwd 0.15s linear infinite;
        }

        #robot-car.moving-backward .wheel {
            animation: wheel-spin-bwd 0.15s linear infinite;
        }

        #robot-car.turning-left .wheel.front-left,
        #robot-car.turning-left .wheel.front-right {
            transform: rotate(-8deg);
            transition: transform 0.1s ease;
        }

        #robot-car.turning-right .wheel.front-left,
        #robot-car.turning-right .wheel.front-right {
            transform: rotate(8deg);
            transition: transform 0.1s ease;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
</head>

<body class="bg-gray-100 min-h-screen p-2 sm:p-4 font-sans flex justify-center items-start">
    <div class="w-full max-w-6xl flex flex-col h-[calc(100vh-1rem)] space-y-3">
        
        <header class="text-center flex-shrink-0 mt-2">
            <h1 class="text-3xl font-extrabold text-teal-600 mb-1">ü§ñ Robot Data Explorer</h1>
            <p class="text-lg text-gray-600">Analyze your mission data and see the robot move!</p>
        </header>

        <div class="flex gap-4 flex-grow overflow-hidden">
            
            <div class="bg-white p-4 rounded-xl shadow-lg flex-shrink-0 w-80 h-full flex flex-col space-y-4">
                <h2 class="text-xl font-bold text-teal-700">Mission Controls</h2>
                
                <div class="flex-shrink-0 p-3 bg-purple-50 rounded-lg border-2 border-purple-300 shadow-inner">
                    <label class="block text-purple-800 font-extrabold mb-2 text-lg">1. Choose your CSV file:</label>
                    <input type="file" id="csvFileInput" accept=".csv" class="w-full text-sm text-gray-700
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-bold
                        file:bg-purple-200 file:text-purple-800
                        hover:file:bg-purple-300 transition duration-150" />
                </div>

                <div class="flex flex-col space-y-2 flex-shrink-0">
                    <button id="startButton" class="bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-emerald-600 transition duration-150 transform hover:scale-105 text-sm" disabled>
                        ‚ñ∂Ô∏è Start Simulation
                    </button>
                    <button id="resetButton" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-amber-600 transition duration-150 transform hover:scale-105 text-sm" disabled>
                        üîÑ Reset Robot
                    </button>
                </div>

                <div class="p-2 bg-teal-50 rounded-lg border border-teal-200 flex-grow">
                    <h3 class="text-sm font-semibold text-teal-800 mb-1">Command Key (0.1s per step)</h3>
                    <ul class="text-xs text-gray-700 grid grid-cols-2 gap-x-2">
                        <li><span class="font-mono bg-white px-1 rounded">A = 1:</span> Forward</li>
                        <li><span class="font-mono bg-white px-1 rounded">B = 1:</span> Turn Left</li>
                        <li><span class="font-mono bg-white px-1 rounded">C = 1:</span> Turn Right</li>
                        <li><span class="font-mono bg-white px-1 rounded">D = 1:</span> Backward</li>
                        <li><span class="font-mono bg-white px-1 rounded col-span-2">0,0,0,0:</span> Stop</li>
                    </ul>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-lg flex-grow overflow-hidden flex flex-col">
                <h2 class="text-xl font-bold text-teal-700 mb-2 flex-shrink-0">Live Robot Simulation (Hybrid Map Scrolling)</h2>
                <div id="simulation-area" class="relative flex-grow">
                    <div id="robot-car">
                        <div class="wheel front-left"></div>
                        <div class="wheel front-right"></div>
                        <div class="wheel back-left"></div>
                        <div class="wheel back-right"></div>
                        <div class="headlight left"></div>
                        <div class="headlight right"></div>
                    </div>
                    <div class="absolute text-sm text-gray-600 top-2 left-2">Start Area (Center)</div>
                </div>
            </div>
        </div>
        
    </div>

    <script>
        // --- GLOBAL VARIABLES & CONSTANTS ---
        const csvFileInput = document.getElementById('csvFileInput');
        const startButton = document.getElementById('startButton');
        const resetButton = document.getElementById('resetButton');
        const robotCar = document.getElementById('robot-car');
        const simulationArea = document.getElementById('simulation-area');

        // Initial state of the robot and simulation background
        const INITIAL_STATE = {
            x: 0, // Local position relative to the center of the viewport
            y: 0, 
            globalBgX: 0, // Absolute offset of the map (background)
            globalBgY: 0, 
            angle: 270, // Start facing Up (270 degrees)
            stepIndex: 0,
            isRunning: false
        };

        let robotState = { ...INITIAL_STATE };
        let commandData = []; 
        let animationInterval = null;

        // Movement parameters
        const STEP_DISTANCE = 8; // Pixels to move per 0.1s step
        const TURN_ANGLE = 5; ¬† ¬†// Degrees to turn per 0.1s step
        
        // --- NEW HYBRID CONSTANTS ---
        // Defines the "safe zone" from the center before the map starts scrolling
        const SAFE_ZONE_LIMIT = 150; // Pixels from the center of the simulation area

        // Function to update the robot's visual appearance on the screen
        function updateRobotDisplay() {
            // The robot moves locally (x, y) until it hits the boundary
            robotCar.style.transform = 
                `translate(${robotState.x}px, ${robotState.y}px) rotate(${robotState.angle - 270}deg)`;

            // The 'floor' (simulation-area) background moves by the global offset
            simulationArea.style.backgroundPosition = 
                `${robotState.globalBgX}px ${robotState.globalBgY}px`;
        }

        // Function to reset the robot to the starting position
        function resetRobot() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            robotState = { ...INITIAL_STATE };
            updateRobotDisplay();
            robotCar.classList.remove('moving-forward', 'moving-backward', 'turning-left', 'turning-right');
            startButton.textContent = '‚ñ∂Ô∏è Start Simulation';
            startButton.disabled = commandData.length === 0;
            resetButton.disabled = true;
            logMessage('Robot Reset. Ready for new mission.', 'start');
        }

        // Function to process one command step
        function processStep() {
            if (robotState.stepIndex >= commandData.length) {
                clearInterval(animationInterval);
                animationInterval = null;
                robotState.isRunning = false;
                startButton.textContent = '‚úÖ Mission Complete!';
                startButton.disabled = true;
                robotCar.classList.remove('moving-forward', 'moving-backward', 'turning-left', 'turning-right');
                logMessage('Mission complete! Robot finished all ' + commandData.length + ' steps.', 'success');
                return;
            }

            const command = commandData[robotState.stepIndex];
            const angleInRad = robotState.angle * Math.PI / 180; 
            let actionText = '';
            let newX = robotState.x;
            let newY = robotState.y;

            const isMoving = command.A === 1 || command.D === 1;
            const isTurning = command.B === 1 || command.C === 1;

            robotCar.classList.remove('moving-forward', 'moving-backward', 'turning-left', 'turning-right');

            if (isMoving && isTurning) {
                actionText = 'üö® Conflicting commands detected! Robot is Stopping.';
            } else if (command.A === 1) { // Move Forward
                newX += STEP_DISTANCE * Math.cos(angleInRad);
                newY += STEP_DISTANCE * Math.sin(angleInRad);
                actionText = '‚û°Ô∏è Moving Forward';
                robotCar.classList.add('moving-forward');
            } else if (command.D === 1) { // Move Backward
                newX -= STEP_DISTANCE * Math.cos(angleInRad);
                newY -= STEP_DISTANCE * Math.sin(angleInRad);
                actionText = '‚¨ÖÔ∏è Moving Backward';
                robotCar.classList.add('moving-backward');
            } else if (command.B === 1) { // Turn Left (Decreasing angle)
                robotState.angle -= TURN_ANGLE;
                actionText = '‚Ü©Ô∏è Turning Left';
                robotCar.classList.add('turning-left');
            } else if (command.C === 1) { // Turn Right (Increasing angle)
                robotState.angle += TURN_ANGLE;
                actionText = '‚Ü™Ô∏è Turning Right';
                robotCar.classList.add('turning-right');
            } else { // Stop
                actionText = 'üõë Stopping (0, 0, 0, 0)';
            }

            // --- HYBRID SCROLLING LOGIC ---
            let movedViewport = false;
            
            // Check X boundary
            if (Math.abs(newX) > SAFE_ZONE_LIMIT) {
                const deltaX = newX - robotState.x;
                robotState.globalBgX -= deltaX; // Shift background by the amount the robot moved
                robotState.x = newX > 0 ? SAFE_ZONE_LIMIT : -SAFE_ZONE_LIMIT; // Clamp robot position
                movedViewport = true;
            } else {
                robotState.x = newX; // Robot moves normally
            }

            // Check Y boundary
            if (Math.abs(newY) > SAFE_ZONE_LIMIT) {
                const deltaY = newY - robotState.y;
                robotState.globalBgY -= deltaY; // Shift background by the amount the robot moved
                robotState.y = newY > 0 ? SAFE_ZONE_LIMIT : -SAFE_ZONE_LIMIT; // Clamp robot position
                movedViewport = true;
            } else {
                robotState.y = newY; // Robot moves normally
            }
            // --- END HYBRID SCROLLING LOGIC ---

            // Log if the viewport was shifted
            if (movedViewport) {
                actionText += ' (Viewport Scrolling)';
            }

            // Ensure angle stays between 0 and 360
            robotState.angle = robotState.angle % 360;
            if (robotState.angle < 0) robotState.angle += 360;

            // Update display (robot movement/rotation and background position)
            updateRobotDisplay();
            logMessage(`Step ${command.SR}: ${actionText} | Angle: ${Math.round(robotState.angle)}¬∞ | Local Pos: (${Math.round(robotState.x)}, ${Math.round(robotState.y)})`, 'info');

            robotState.stepIndex++;
        }

        // Function to start the animation loop (Unchanged)
        function startSimulation() {
            if (commandData.length === 0 || robotState.isRunning) return;

            robotState.isRunning = true;
            robotState.stepIndex = 0; 
            startButton.textContent = '‚è∏Ô∏è Running...';
            startButton.disabled = true;
            resetButton.disabled = false;

            animationInterval = setInterval(processStep, 100); 
            logMessage('Simulation Started in Hybrid Mode (Robot moves, Map scrolls near edge)!', 'start');
        }

        // File parsing and utility functions (Unchanged)
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                logMessage('Error: CSV file is empty or too short.', 'error');
                return [];
            }
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length >= 5) {
                    data.push({
                        SR: parseInt(values[0]) || i,
                        A: parseInt(values[1]) || 0,
                        B: parseInt(values[2]) || 0,
                        C: parseInt(values[3]) || 0,
                        D: parseInt(values[4]) || 0,
                    });
                }
            }
            return data;
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                commandData = [];
                startButton.disabled = true;
                logMessage('Please select a CSV file.', 'warn');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    commandData = parseCSV(text);
                    if (commandData.length > 0) {
                        logMessage(`File loaded! Found ${commandData.length} steps in the mission.`, 'success');
                        startButton.disabled = false;
                        resetRobot();
                    } else {
                        logMessage('Error: Could not parse any valid robot commands from the file.', 'error');
                        startButton.disabled = true;
                    }
                } catch (err) {
                    logMessage('Error reading file: ' + err.message, 'error');
                    startButton.disabled = true;
                }
            };
            reader.readAsText(file);
        }
        
        function logMessage(message, type = 'info') {
            const colorMap = {
                success: 'green',
                error: 'red',
                warn: 'orange',
                start: 'blue',
                info: 'gray'
            };
            const prefix = type.toUpperCase() + ':';
            console.log(`%c${prefix} ${message}`, `color: ${colorMap[type] || 'black'}; font-weight: bold;`);
        }

        // --- EVENT LISTENERS ---
        csvFileInput.addEventListener('change', handleFileSelect);
        startButton.addEventListener('click', startSimulation);
        resetButton.addEventListener('click', resetRobot);

        // Initialize the robot's position and appearance
        window.onload = function() {
            resetRobot();
            logMessage('Application initialized. Upload your data file to begin.', 'start');
        };

    </script>
</body>
</html>
